# ============================================================
# RR-Bank Microservices - Docker Compose for Oracle Cloud
# ============================================================
# This configuration uses OCI managed services:
# - OCI PostgreSQL for database
# - OCI Streaming for Kafka
# - OCI Cache for Redis
# ============================================================
# Services: 9 Microservices + API Gateway + 2 Frontends
# ============================================================

services:
  # ============================================================
  # MICROSERVICES
  # ============================================================

  # Auth Service (8081)
  auth-service:
    image: ${OCI_REGION}.ocir.io/${OCI_NAMESPACE}/rrbank/auth-service:${TAG:-latest}
    container_name: rrbank-auth
    ports:
      - "8081:8081"
    environment:
      SPRING_PROFILES_ACTIVE: oracle
      SERVER_PORT: 8081
      SPRING_DATASOURCE_URL: ${DATABASE_URL}
      SPRING_DATASOURCE_USERNAME: ${DATABASE_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DATABASE_PASSWORD}
      SPRING_REDIS_HOST: ${REDIS_HOST}
      SPRING_REDIS_PORT: ${REDIS_PORT:-6379}
      SPRING_REDIS_PASSWORD: ${REDIS_PASSWORD}
      SPRING_DATA_REDIS_SSL_ENABLED: "true"
      SPRING_KAFKA_ENABLED: "true"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS}
      SPRING_KAFKA_PROPERTIES_SECURITY_PROTOCOL: SASL_SSL
      SPRING_KAFKA_PROPERTIES_SASL_MECHANISM: PLAIN
      SPRING_KAFKA_PROPERTIES_SASL_JAAS_CONFIG: ${KAFKA_SASL_JAAS_CONFIG}
      JWT_SECRET: ${JWT_SECRET}
      SERVICES_NOTIFICATION_URL: http://notification-service:8086
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8081/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - rrbank-network

  # Customer Service (8082)
  customer-service:
    image: ${OCI_REGION}.ocir.io/${OCI_NAMESPACE}/rrbank/customer-service:${TAG:-latest}
    container_name: rrbank-customer
    ports:
      - "8082:8082"
    environment:
      SPRING_PROFILES_ACTIVE: oracle
      SERVER_PORT: 8082
      SPRING_DATASOURCE_URL: ${DATABASE_URL}
      SPRING_DATASOURCE_USERNAME: ${DATABASE_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DATABASE_PASSWORD}
      SPRING_KAFKA_ENABLED: "true"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS}
      SPRING_KAFKA_PROPERTIES_SECURITY_PROTOCOL: SASL_SSL
      SPRING_KAFKA_PROPERTIES_SASL_MECHANISM: PLAIN
      SPRING_KAFKA_PROPERTIES_SASL_JAAS_CONFIG: ${KAFKA_SASL_JAAS_CONFIG}
      JWT_SECRET: ${JWT_SECRET}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8082/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - rrbank-network

  # Ledger Service (8085) - Source of Truth
  ledger-service:
    image: ${OCI_REGION}.ocir.io/${OCI_NAMESPACE}/rrbank/ledger-service:${TAG:-latest}
    container_name: rrbank-ledger
    ports:
      - "8085:8085"
    environment:
      SPRING_PROFILES_ACTIVE: oracle
      SERVER_PORT: 8085
      SPRING_DATASOURCE_URL: ${DATABASE_URL}
      SPRING_DATASOURCE_USERNAME: ${DATABASE_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DATABASE_PASSWORD}
      SPRING_REDIS_HOST: ${REDIS_HOST}
      SPRING_REDIS_PORT: ${REDIS_PORT:-6379}
      SPRING_REDIS_PASSWORD: ${REDIS_PASSWORD}
      SPRING_DATA_REDIS_SSL_ENABLED: "true"
      SPRING_KAFKA_ENABLED: "true"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS}
      SPRING_KAFKA_PROPERTIES_SECURITY_PROTOCOL: SASL_SSL
      SPRING_KAFKA_PROPERTIES_SASL_MECHANISM: PLAIN
      SPRING_KAFKA_PROPERTIES_SASL_JAAS_CONFIG: ${KAFKA_SASL_JAAS_CONFIG}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8085/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - rrbank-network

  # Account Service (8083)
  account-service:
    image: ${OCI_REGION}.ocir.io/${OCI_NAMESPACE}/rrbank/account-service:${TAG:-latest}
    container_name: rrbank-account
    ports:
      - "8083:8083"
    environment:
      SPRING_PROFILES_ACTIVE: oracle
      SERVER_PORT: 8083
      SPRING_DATASOURCE_URL: ${DATABASE_URL}
      SPRING_DATASOURCE_USERNAME: ${DATABASE_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DATABASE_PASSWORD}
      SPRING_REDIS_HOST: ${REDIS_HOST}
      SPRING_REDIS_PORT: ${REDIS_PORT:-6379}
      SPRING_REDIS_PASSWORD: ${REDIS_PASSWORD}
      SPRING_DATA_REDIS_SSL_ENABLED: "true"
      SPRING_KAFKA_ENABLED: "true"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS}
      SPRING_KAFKA_PROPERTIES_SECURITY_PROTOCOL: SASL_SSL
      SPRING_KAFKA_PROPERTIES_SASL_MECHANISM: PLAIN
      SPRING_KAFKA_PROPERTIES_SASL_JAAS_CONFIG: ${KAFKA_SASL_JAAS_CONFIG}
      JWT_SECRET: ${JWT_SECRET}
      SERVICES_LEDGER_URL: http://ledger-service:8085
      SERVICES_CUSTOMER_URL: http://customer-service:8082
      SERVICES_NOTIFICATION_URL: http://notification-service:8086
    depends_on:
      - ledger-service
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8083/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - rrbank-network

  # Fraud Service (8087)
  fraud-service:
    image: ${OCI_REGION}.ocir.io/${OCI_NAMESPACE}/rrbank/fraud-service:${TAG:-latest}
    container_name: rrbank-fraud
    ports:
      - "8087:8087"
    environment:
      SPRING_PROFILES_ACTIVE: oracle
      SERVER_PORT: 8087
      SPRING_DATASOURCE_URL: ${DATABASE_URL}
      SPRING_DATASOURCE_USERNAME: ${DATABASE_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DATABASE_PASSWORD}
      SPRING_REDIS_HOST: ${REDIS_HOST}
      SPRING_REDIS_PORT: ${REDIS_PORT:-6379}
      SPRING_REDIS_PASSWORD: ${REDIS_PASSWORD}
      SPRING_DATA_REDIS_SSL_ENABLED: "true"
      SPRING_KAFKA_ENABLED: "true"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS}
      SPRING_KAFKA_PROPERTIES_SECURITY_PROTOCOL: SASL_SSL
      SPRING_KAFKA_PROPERTIES_SASL_MECHANISM: PLAIN
      SPRING_KAFKA_PROPERTIES_SASL_JAAS_CONFIG: ${KAFKA_SASL_JAAS_CONFIG}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8087/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - rrbank-network

  # Transaction Service (8084)
  transaction-service:
    image: ${OCI_REGION}.ocir.io/${OCI_NAMESPACE}/rrbank/transaction-service:${TAG:-latest}
    container_name: rrbank-transaction
    ports:
      - "8084:8084"
    environment:
      SPRING_PROFILES_ACTIVE: oracle
      SERVER_PORT: 8084
      SPRING_DATASOURCE_URL: ${DATABASE_URL}
      SPRING_DATASOURCE_USERNAME: ${DATABASE_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DATABASE_PASSWORD}
      SPRING_REDIS_HOST: ${REDIS_HOST}
      SPRING_REDIS_PORT: ${REDIS_PORT:-6379}
      SPRING_REDIS_PASSWORD: ${REDIS_PASSWORD}
      SPRING_DATA_REDIS_SSL_ENABLED: "true"
      SPRING_KAFKA_ENABLED: "true"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS}
      SPRING_KAFKA_PROPERTIES_SECURITY_PROTOCOL: SASL_SSL
      SPRING_KAFKA_PROPERTIES_SASL_MECHANISM: PLAIN
      SPRING_KAFKA_PROPERTIES_SASL_JAAS_CONFIG: ${KAFKA_SASL_JAAS_CONFIG}
      JWT_SECRET: ${JWT_SECRET}
      SERVICES_LEDGER_URL: http://ledger-service:8085
      SERVICES_ACCOUNT_URL: http://account-service:8083
      SERVICES_FRAUD_URL: http://fraud-service:8087
      SERVICES_NOTIFICATION_URL: http://notification-service:8086
    depends_on:
      - ledger-service
      - fraud-service
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8084/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - rrbank-network

  # Notification Service (8086)
  notification-service:
    image: ${OCI_REGION}.ocir.io/${OCI_NAMESPACE}/rrbank/notification-service:${TAG:-latest}
    container_name: rrbank-notification
    ports:
      - "8086:8086"
    environment:
      SPRING_PROFILES_ACTIVE: oracle
      SERVER_PORT: 8086
      SPRING_DATASOURCE_URL: ${DATABASE_URL}
      SPRING_DATASOURCE_USERNAME: ${DATABASE_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DATABASE_PASSWORD}
      SPRING_KAFKA_ENABLED: "true"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS}
      SPRING_KAFKA_PROPERTIES_SECURITY_PROTOCOL: SASL_SSL
      SPRING_KAFKA_PROPERTIES_SASL_MECHANISM: PLAIN
      SPRING_KAFKA_PROPERTIES_SASL_JAAS_CONFIG: ${KAFKA_SASL_JAAS_CONFIG}
      JWT_SECRET: ${JWT_SECRET}
      MAIL_HOST: ${MAIL_HOST:-smtp.gmail.com}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      APP_NAME: ${APP_NAME:-RR Bank}
      FRONTEND_URL: ${FRONTEND_URL}
      EMAIL_ENABLED: "true"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8086/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - rrbank-network

  # Audit Service (8088)
  audit-service:
    image: ${OCI_REGION}.ocir.io/${OCI_NAMESPACE}/rrbank/audit-service:${TAG:-latest}
    container_name: rrbank-audit
    ports:
      - "8088:8088"
    environment:
      SPRING_PROFILES_ACTIVE: oracle
      SERVER_PORT: 8088
      SPRING_DATASOURCE_URL: ${DATABASE_URL}
      SPRING_DATASOURCE_USERNAME: ${DATABASE_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DATABASE_PASSWORD}
      SPRING_KAFKA_ENABLED: "true"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS}
      SPRING_KAFKA_PROPERTIES_SECURITY_PROTOCOL: SASL_SSL
      SPRING_KAFKA_PROPERTIES_SASL_MECHANISM: PLAIN
      SPRING_KAFKA_PROPERTIES_SASL_JAAS_CONFIG: ${KAFKA_SASL_JAAS_CONFIG}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8088/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - rrbank-network

  # Admin Service (8089) - NEW
  admin-service:
    image: ${OCI_REGION}.ocir.io/${OCI_NAMESPACE}/rrbank/admin-service:${TAG:-latest}
    container_name: rrbank-admin
    ports:
      - "8089:8089"
    environment:
      SPRING_PROFILES_ACTIVE: oracle
      SERVER_PORT: 8089
      SPRING_DATASOURCE_URL: ${DATABASE_URL}
      SPRING_DATASOURCE_USERNAME: ${DATABASE_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DATABASE_PASSWORD}
      SPRING_REDIS_HOST: ${REDIS_HOST}
      SPRING_REDIS_PORT: ${REDIS_PORT:-6379}
      SPRING_REDIS_PASSWORD: ${REDIS_PASSWORD}
      SPRING_DATA_REDIS_SSL_ENABLED: "true"
      JWT_SECRET: ${JWT_SECRET}
      ADMIN_USERNAME: ${ADMIN_USERNAME:-superadmin}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@rrbank.com}
      SERVICES_AUTH_URL: http://auth-service:8081
      SERVICES_CUSTOMER_URL: http://customer-service:8082
      SERVICES_ACCOUNT_URL: http://account-service:8083
      SERVICES_TRANSACTION_URL: http://transaction-service:8084
      SERVICES_LEDGER_URL: http://ledger-service:8085
      SERVICES_NOTIFICATION_URL: http://notification-service:8086
      SERVICES_FRAUD_URL: http://fraud-service:8087
      SERVICES_AUDIT_URL: http://audit-service:8088
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8089/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - rrbank-network

  # API Gateway (8080)
  api-gateway:
    image: ${OCI_REGION}.ocir.io/${OCI_NAMESPACE}/rrbank/api-gateway:${TAG:-latest}
    container_name: rrbank-gateway
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: oracle
      SERVER_PORT: 8080
      JWT_SECRET: ${JWT_SECRET}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
      AUTH_SERVICE_URL: http://auth-service:8081
      CUSTOMER_SERVICE_URL: http://customer-service:8082
      ACCOUNT_SERVICE_URL: http://account-service:8083
      TRANSACTION_SERVICE_URL: http://transaction-service:8084
      LEDGER_SERVICE_URL: http://ledger-service:8085
      NOTIFICATION_SERVICE_URL: http://notification-service:8086
      FRAUD_SERVICE_URL: http://fraud-service:8087
      AUDIT_SERVICE_URL: http://audit-service:8088
      ADMIN_SERVICE_URL: http://admin-service:8089
    depends_on:
      - auth-service
      - customer-service
      - account-service
      - transaction-service
      - ledger-service
      - notification-service
      - fraud-service
      - audit-service
      - admin-service
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - rrbank-network

  # Customer Frontend (3000)
  frontend:
    image: ${OCI_REGION}.ocir.io/${OCI_NAMESPACE}/rrbank/frontend:${TAG:-latest}
    container_name: rrbank-frontend
    ports:
      - "3000:80"
    environment:
      VITE_API_URL: ${VITE_API_URL}
    depends_on:
      - api-gateway
    restart: unless-stopped
    networks:
      - rrbank-network

  # Admin Frontend (3001)
  admin-frontend:
    image: ${OCI_REGION}.ocir.io/${OCI_NAMESPACE}/rrbank/admin-frontend:${TAG:-latest}
    container_name: rrbank-admin-frontend
    ports:
      - "3001:80"
    environment:
      VITE_API_URL: ${VITE_API_URL}
    depends_on:
      - api-gateway
    restart: unless-stopped
    networks:
      - rrbank-network

networks:
  rrbank-network:
    driver: bridge
